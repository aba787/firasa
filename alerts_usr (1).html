
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>âš ï¸ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

<!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ -->
<header class="bg-indigo-700 text-white p-4 flex justify-between items-center">
  <h1 class="text-xl font-bold">ğŸ“Š ÙØ±Ø§Ø³Ø© - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
  <div class="flex items-center space-x-4 space-x-reverse">
    <div class="relative">
      <span class="mr-4">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <strong id="headerUserName">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</strong></span>
      <div id="alertBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center hidden">
        <span id="alertCount">0</span>
      </div>
    </div>
    <button onclick="refreshAlerts()" class="bg-indigo-500 hover:bg-indigo-600 px-3 py-1 rounded text-sm transition-colors">
      ğŸ”„ ØªØ­Ø¯ÙŠØ«
    </button>
  </div>
</header>

<!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
<div class="max-w-7xl mx-auto p-6 grid grid-cols-1 md:grid-cols-4 gap-6">

  <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
  <aside class="bg-white shadow rounded-xl p-4 col-span-1">
    <ul class="space-y-4">
      <li><a href="Dashboard.html" class="block text-gray-700 hover:text-indigo-600 transition-colors">ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
      <li><a href="add-operation.html" class="block text-gray-700 hover:text-indigo-600 transition-colors">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©</a></li>
      <li><a href="reports_usr.html" class="block text-gray-700 hover:text-indigo-600 transition-colors">ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</a></li>
      <li><a href="alerts_usr.html" class="block text-indigo-600 hover:text-indigo-800 font-bold bg-indigo-50 px-3 py-2 rounded-lg">âš ï¸ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</a></li>
      <li><a href="accounts_lm.html" class="block text-gray-700 hover:text-indigo-600 transition-colors">ğŸ’³ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©</a></li>
      <li><a href="settings_usr.html" class="block text-gray-700 hover:text-indigo-600 transition-colors">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a></li>
    </ul>
  </aside>

  <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© -->
  <main class="col-span-3 space-y-6">

    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-red-50 p-4 rounded-xl border border-red-200">
        <div class="flex items-center">
          <div class="text-2xl text-red-600 ml-3">ğŸš¨</div>
          <div>
            <p class="text-sm text-red-600 font-medium">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ø§Ø¬Ù„Ø©</p>
            <p class="text-xl font-bold text-red-700" id="criticalAlerts">0</p>
          </div>
        </div>
      </div>
      
      <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
        <div class="flex items-center">
          <div class="text-2xl text-yellow-600 ml-3">âš ï¸</div>
          <div>
            <p class="text-sm text-yellow-600 font-medium">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ù‡Ù…Ø©</p>
            <p class="text-xl font-bold text-yellow-700" id="warningAlerts">0</p>
          </div>
        </div>
      </div>
      
      <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
        <div class="flex items-center">
          <div class="text-2xl text-blue-600 ml-3">â„¹ï¸</div>
          <div>
            <p class="text-sm text-blue-600 font-medium">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¥Ø¹Ù„Ø§Ù…ÙŠØ©</p>
            <p class="text-xl font-bold text-blue-700" id="infoAlerts">0</p>
          </div>
        </div>
      </div>
      
      <div class="bg-green-50 p-4 rounded-xl border border-green-200">
        <div class="flex items-center">
          <div class="text-2xl text-green-600 ml-3">âœ…</div>
          <div>
            <p class="text-sm text-green-600 font-medium">ØªÙ… Ø§Ù„Ø­Ù„</p>
            <p class="text-xl font-bold text-green-700" id="resolvedAlerts">0</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ÙÙ„ØªØ±Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
    <div class="bg-white p-6 rounded-xl shadow">
      <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ” ÙÙ„ØªØ±Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h3>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</label>
          <select id="alertTypeFilter" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="critical">Ø¹Ø§Ø¬Ù„</option>
            <option value="warning">Ù…Ù‡Ù…</option>
            <option value="info">Ø¥Ø¹Ù„Ø§Ù…ÙŠ</option>
            <option value="resolved">ØªÙ… Ø§Ù„Ø­Ù„</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ÙØ¦Ø©</label>
          <select id="categoryFilter" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="financial">Ù…Ø§Ù„ÙŠ</option>
            <option value="security">Ø£Ù…Ù†ÙŠ</option>
            <option value="system">Ù†Ø¸Ø§Ù…</option>
            <option value="operation">Ø¹Ù…Ù„ÙŠØ§ØªÙŠ</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="dateFromFilter" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="dateToFilter" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div class="flex items-end">
          <button onclick="applyFilters()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-200">
            ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
          </button>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div class="bg-white p-6 rounded-xl shadow">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-800">âš ï¸ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h2>
        <div class="flex space-x-2 space-x-reverse">
          <button onclick="markAllAsRead()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 text-sm">
            âœ… ØªØ¹Ù„ÙŠÙ… Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡
          </button>
          <button onclick="deleteAllResolved()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200 text-sm">
            ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©
          </button>
          <button onclick="exportAlerts()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 text-sm">
            ğŸ“‹ ØªØµØ¯ÙŠØ±
          </button>
        </div>
      </div>

      <div id="alertsList" class="space-y-3">
        <div class="text-center py-8 text-gray-500">
          <div class="text-4xl mb-4">ğŸ””</div>
          <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª...</p>
        </div>
      </div>
    </div>

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
    <div class="bg-white p-6 rounded-xl shadow">
      <h3 class="text-lg font-bold text-gray-800 mb-4">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <h4 class="font-semibold text-gray-700">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ø§Ù„ÙŠØ©</h4>
          <label class="flex items-center">
            <input type="checkbox" id="financialAlerts" class="mr-2" checked>
            <span>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø±ØµÙŠØ¯</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" id="expenseAlerts" class="mr-2" checked>
            <span>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" id="revenueAlerts" class="mr-2" checked>
            <span>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span>
          </label>
        </div>
        <div class="space-y-4">
          <h4 class="font-semibold text-gray-700">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
          <label class="flex items-center">
            <input type="checkbox" id="securityAlerts" class="mr-2" checked>
            <span>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø£Ù…Ù†ÙŠØ©</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" id="systemAlerts" class="mr-2" checked>
            <span>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" id="emailNotifications" class="mr-2">
            <span>Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span>
          </label>
        </div>
      </div>
      <button onclick="saveAlertSettings()" class="mt-4 bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition duration-200">
        Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      </button>
    </div>
  </main>
</div>

<!-- Modal for Alert Details -->
<div id="alertModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold text-gray-800">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</h3>
      <button onclick="closeAlertModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    <div id="alertModalContent">
      <!-- Alert details will be loaded here -->
    </div>
  </div>
</div>

<!-- Notification Container -->
<div id="notification-container" class="fixed top-4 left-4 z-50 space-y-2"></div>

<script>
// Global variables
let allAlerts = [];
let filteredAlerts = [];
let alertSettings = {};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadUserData();
    loadAlertSettings();
    initializeAlerts();
    loadAlerts();
    setupEventListeners();
    
    // Start real-time updates
    setInterval(generateRandomAlert, 30000); // Every 30 seconds
    setInterval(updateAlertCounts, 5000); // Every 5 seconds
});

// Load user data
function loadUserData() {
    const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
    if (userData.fullname) {
        document.getElementById('headerUserName').textContent = userData.fullname;
    }
}

// Load alert settings
function loadAlertSettings() {
    alertSettings = JSON.parse(localStorage.getItem('alertSettings') || '{}');
    
    // Set default values
    const defaults = {
        financialAlerts: true,
        expenseAlerts: true,
        revenueAlerts: true,
        securityAlerts: true,
        systemAlerts: true,
        emailNotifications: false
    };
    
    Object.keys(defaults).forEach(key => {
        const value = alertSettings[key] !== undefined ? alertSettings[key] : defaults[key];
        const checkbox = document.getElementById(key);
        if (checkbox) {
            checkbox.checked = value;
        }
    });
}

// Initialize alerts with sample data
function initializeAlerts() {
    const existingAlerts = localStorage.getItem('userAlerts');
    if (!existingAlerts) {
        const sampleAlerts = [
            {
                id: 'alert-1',
                type: 'critical',
                category: 'financial',
                title: 'Ø§Ù†Ø®ÙØ§Ø¶ Ø­Ø§Ø¯ ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯',
                message: 'Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ù‚Ù„ Ù…Ù† 10% Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ. ÙŠÙÙ†ØµØ­ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ.',
                timestamp: new Date(Date.now() - 1000 * 60 * 30).toISOString(), // 30 minutes ago
                isRead: false,
                isResolved: false,
                actions: ['Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', 'Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ¯Ø§Ø¹']
            },
            {
                id: 'alert-2',
                type: 'warning',
                category: 'operation',
                title: 'Ø§Ø±ØªÙØ§Ø¹ ÙÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                message: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø§Ø±ØªÙØ¹Øª Ø¨Ù†Ø³Ø¨Ø© 45% Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ.',
                timestamp: new Date(Date.now() - 1000 * 60 * 60 * 2).toISOString(), // 2 hours ago
                isRead: false,
                isResolved: false,
                actions: ['ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', 'ÙˆØ¶Ø¹ Ø­Ø¯ Ø£Ù‚ØµÙ‰']
            },
            {
                id: 'alert-3',
                type: 'info',
                category: 'system',
                title: 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø­',
                message: 'ÙŠØªÙˆÙØ± ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù„Ù†Ø¸Ø§Ù… ÙØ±Ø§Ø³Ø© ÙŠØªØ¶Ù…Ù† ØªØ­Ø³ÙŠÙ†Ø§Øª Ø£Ù…Ù†ÙŠØ© ÙˆÙ…Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.',
                timestamp: new Date(Date.now() - 1000 * 60 * 60 * 6).toISOString(), // 6 hours ago
                isRead: true,
                isResolved: false,
                actions: ['ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†', 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„']
            },
            {
                id: 'alert-4',
                type: 'warning',
                category: 'security',
                title: 'Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯Ø®ÙˆÙ„ Ù…Ø´Ø¨ÙˆÙ‡Ø©',
                message: 'ØªÙ… Ø±ØµØ¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø¹Ù†ÙˆØ§Ù† IP ØºÙŠØ± Ù…Ø£Ù„ÙˆÙ. ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.',
                timestamp: new Date(Date.now() - 1000 * 60 * 60 * 24).toISOString(), // 1 day ago
                isRead: false,
                isResolved: true,
                actions: ['Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª', 'ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø£Ù…Ø§Ù†']
            }
        ];
        
        localStorage.setItem('userAlerts', JSON.stringify(sampleAlerts));
    }
}

// Load alerts
function loadAlerts() {
    allAlerts = JSON.parse(localStorage.getItem('userAlerts') || '[]');
    filteredAlerts = [...allAlerts];
    
    updateAlertCounts();
    displayAlerts();
}

// Setup event listeners
function setupEventListeners() {
    document.getElementById('alertTypeFilter').addEventListener('change', applyFilters);
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('dateFromFilter').addEventListener('change', applyFilters);
    document.getElementById('dateToFilter').addEventListener('change', applyFilters);
}

// Apply filters
function applyFilters() {
    const typeFilter = document.getElementById('alertTypeFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const dateFromFilter = document.getElementById('dateFromFilter').value;
    const dateToFilter = document.getElementById('dateToFilter').value;
    
    filteredAlerts = allAlerts.filter(alert => {
        let matches = true;
        
        if (typeFilter && alert.type !== typeFilter) matches = false;
        if (categoryFilter && alert.category !== categoryFilter) matches = false;
        
        const alertDate = new Date(alert.timestamp).toISOString().split('T')[0];
        if (dateFromFilter && alertDate < dateFromFilter) matches = false;
        if (dateToFilter && alertDate > dateToFilter) matches = false;
        
        return matches;
    });
    
    displayAlerts();
    updateAlertCounts();
}

// Update alert counts
function updateAlertCounts() {
    const counts = {
        critical: 0,
        warning: 0,
        info: 0,
        resolved: 0
    };
    
    filteredAlerts.forEach(alert => {
        if (alert.isResolved) {
            counts.resolved++;
        } else {
            counts[alert.type]++;
        }
    });
    
    document.getElementById('criticalAlerts').textContent = counts.critical;
    document.getElementById('warningAlerts').textContent = counts.warning;
    document.getElementById('infoAlerts').textContent = counts.info;
    document.getElementById('resolvedAlerts').textContent = counts.resolved;
    
    // Update badge
    const totalUnread = allAlerts.filter(alert => !alert.isRead && !alert.isResolved).length;
    const badge = document.getElementById('alertBadge');
    const badgeCount = document.getElementById('alertCount');
    
    if (totalUnread > 0) {
        badge.classList.remove('hidden');
        badgeCount.textContent = totalUnread;
    } else {
        badge.classList.add('hidden');
    }
}

// Display alerts
function displayAlerts() {
    const container = document.getElementById('alertsList');
    
    if (filteredAlerts.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <div class="text-4xl mb-4">ğŸ””</div>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ${document.getElementById('alertTypeFilter').value ? 'Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„ØªØ±' : 'Ø­Ø§Ù„ÙŠØ§Ù‹'}</p>
            </div>
        `;
        return;
    }
    
    const sortedAlerts = [...filteredAlerts].sort((a, b) => {
        // Unread first, then by timestamp (newest first)
        if (a.isRead !== b.isRead) return a.isRead ? 1 : -1;
        return new Date(b.timestamp) - new Date(a.timestamp);
    });
    
    container.innerHTML = sortedAlerts.map(alert => createAlertElement(alert)).join('');
}

// Create alert element
function createAlertElement(alert) {
    const typeConfig = {
        critical: { 
            color: 'border-red-500 bg-red-50', 
            icon: 'ğŸš¨', 
            textColor: 'text-red-700',
            badgeColor: 'bg-red-500'
        },
        warning: { 
            color: 'border-yellow-500 bg-yellow-50', 
            icon: 'âš ï¸', 
            textColor: 'text-yellow-700',
            badgeColor: 'bg-yellow-500'
        },
        info: { 
            color: 'border-blue-500 bg-blue-50', 
            icon: 'â„¹ï¸', 
            textColor: 'text-blue-700',
            badgeColor: 'bg-blue-500'
        }
    };
    
    const config = typeConfig[alert.type] || typeConfig.info;
    const timeAgo = getTimeAgo(alert.timestamp);
    const readClass = alert.isRead ? 'opacity-75' : '';
    const resolvedClass = alert.isResolved ? 'opacity-50' : '';
    
    return `
        <div class="p-4 ${config.color} border-r-4 rounded-lg hover:shadow-md transition-shadow cursor-pointer ${readClass} ${resolvedClass}"
             onclick="showAlertDetails('${alert.id}')">
            <div class="flex items-start justify-between">
                <div class="flex items-start space-x-3 space-x-reverse flex-1">
                    <div class="text-2xl">${config.icon}</div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 space-x-reverse mb-1">
                            <h4 class="font-bold ${config.textColor}">${alert.title}</h4>
                            ${!alert.isRead ? '<span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full">Ø¬Ø¯ÙŠØ¯</span>' : ''}
                            ${alert.isResolved ? '<span class="bg-green-500 text-white text-xs px-2 py-1 rounded-full">ØªÙ… Ø§Ù„Ø­Ù„</span>' : ''}
                        </div>
                        <p class="text-gray-700 text-sm mb-2">${alert.message}</p>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">${timeAgo} â€¢ ${getCategoryName(alert.category)}</span>
                            <div class="flex space-x-2 space-x-reverse">
                                ${alert.actions.map(action => 
                                    `<button onclick="event.stopPropagation(); handleAlertAction('${alert.id}', '${action}')" 
                                             class="text-xs bg-white ${config.textColor} px-2 py-1 rounded border hover:bg-gray-50 transition-colors">
                                        ${action}
                                    </button>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col space-y-1 mr-2">
                    <button onclick="event.stopPropagation(); toggleAlertRead('${alert.id}')" 
                            class="text-gray-500 hover:text-gray-700 text-sm" 
                            title="${alert.isRead ? 'ØªØ¹Ù„ÙŠÙ… ÙƒØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡' : 'ØªØ¹Ù„ÙŠÙ… ÙƒÙ…Ù‚Ø±ÙˆØ¡'}">
                        ${alert.isRead ? 'ğŸ“–' : 'ğŸ“§'}
                    </button>
                    ${!alert.isResolved ? 
                        `<button onclick="event.stopPropagation(); resolveAlert('${alert.id}')" 
                                 class="text-gray-500 hover:text-green-600 text-sm" 
                                 title="ØªØ¹Ù„ÙŠÙ… ÙƒÙ…Ø­Ù„ÙˆÙ„">
                            âœ…
                        </button>` : ''
                    }
                    <button onclick="event.stopPropagation(); deleteAlert('${alert.id}')" 
                            class="text-gray-500 hover:text-red-600 text-sm" 
                            title="Ø­Ø°Ù Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡">
                        ğŸ—‘ï¸
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Get category name in Arabic
function getCategoryName(category) {
    const categories = {
        financial: 'Ù…Ø§Ù„ÙŠ',
        security: 'Ø£Ù…Ù†ÙŠ',
        system: 'Ù†Ø¸Ø§Ù…',
        operation: 'Ø¹Ù…Ù„ÙŠØ§ØªÙŠ'
    };
    return categories[category] || category;
}

// Get time ago
function getTimeAgo(timestamp) {
    const now = new Date();
    const alertTime = new Date(timestamp);
    const diffMs = now - alertTime;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffMins < 1) return 'Ø§Ù„Ø¢Ù†';
    if (diffMins < 60) return `Ù…Ù†Ø° ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
    if (diffHours < 24) return `Ù…Ù†Ø° ${diffHours} Ø³Ø§Ø¹Ø©`;
    return `Ù…Ù†Ø° ${diffDays} ÙŠÙˆÙ…`;
}

// Show alert details in modal
function showAlertDetails(alertId) {
    const alert = allAlerts.find(a => a.id === alertId);
    if (!alert) return;
    
    // Mark as read
    if (!alert.isRead) {
        toggleAlertRead(alertId);
    }
    
    const typeConfig = {
        critical: { color: 'text-red-700', bgColor: 'bg-red-50', icon: 'ğŸš¨' },
        warning: { color: 'text-yellow-700', bgColor: 'bg-yellow-50', icon: 'âš ï¸' },
        info: { color: 'text-blue-700', bgColor: 'bg-blue-50', icon: 'â„¹ï¸' }
    };
    
    const config = typeConfig[alert.type] || typeConfig.info;
    
    document.getElementById('alertModalContent').innerHTML = `
        <div class="space-y-4">
            <div class="flex items-center space-x-3 space-x-reverse ${config.bgColor} p-4 rounded-lg">
                <div class="text-3xl">${config.icon}</div>
                <div>
                    <h4 class="text-xl font-bold ${config.color}">${alert.title}</h4>
                    <p class="text-sm text-gray-600">${getCategoryName(alert.category)} â€¢ ${getTimeAgo(alert.timestamp)}</p>
                </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
                <h5 class="font-semibold mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡:</h5>
                <p class="text-gray-700">${alert.message}</p>
            </div>
            
            <div class="bg-blue-50 p-4 rounded-lg">
                <h5 class="font-semibold mb-2">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:</h5>
                <div class="space-y-2">
                    ${alert.actions.map(action => 
                        `<button onclick="handleAlertAction('${alert.id}', '${action}'); closeAlertModal();" 
                                 class="block w-full text-right bg-white border border-blue-200 px-4 py-2 rounded hover:bg-blue-50 transition-colors">
                            ${action}
                        </button>`
                    ).join('')}
                </div>
            </div>
            
            <div class="flex space-x-3 space-x-reverse pt-4 border-t">
                ${!alert.isResolved ? 
                    `<button onclick="resolveAlert('${alert.id}'); closeAlertModal();" 
                             class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        âœ… ØªØ¹Ù„ÙŠÙ… ÙƒÙ…Ø­Ù„ÙˆÙ„
                    </button>` : 
                    '<span class="bg-green-100 text-green-700 px-4 py-2 rounded-lg">âœ… ØªÙ… Ø§Ù„Ø­Ù„</span>'
                }
                <button onclick="deleteAlert('${alert.id}'); closeAlertModal();" 
                        class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                    ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('alertModal').classList.remove('hidden');
}

// Close alert modal
function closeAlertModal() {
    document.getElementById('alertModal').classList.add('hidden');
}

// Toggle alert read status
function toggleAlertRead(alertId) {
    const alertIndex = allAlerts.findIndex(a => a.id === alertId);
    if (alertIndex !== -1) {
        allAlerts[alertIndex].isRead = !allAlerts[alertIndex].isRead;
        saveAlerts();
        loadAlerts();
    }
}

// Resolve alert
function resolveAlert(alertId) {
    const alertIndex = allAlerts.findIndex(a => a.id === alertId);
    if (alertIndex !== -1) {
        allAlerts[alertIndex].isResolved = true;
        allAlerts[alertIndex].isRead = true;
        saveAlerts();
        loadAlerts();
        showNotification('ØªÙ… ØªØ¹Ù„ÙŠÙ… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙƒÙ…Ø­Ù„ÙˆÙ„', 'success');
    }
}

// Delete alert
function deleteAlert(alertId) {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ØŸ')) {
        allAlerts = allAlerts.filter(a => a.id !== alertId);
        saveAlerts();
        loadAlerts();
        showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡', 'info');
    }
}

// Handle alert actions
function handleAlertAction(alertId, action) {
    const actionMap = {
        'Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±': () => window.location.href = 'reports_usr.html',
        'Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ¯Ø§Ø¹': () => window.location.href = 'add-operation.html',
        'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª': () => window.location.href = 'reports_usr.html',
        'ÙˆØ¶Ø¹ Ø­Ø¯ Ø£Ù‚ØµÙ‰': () => window.location.href = 'settings_usr.html',
        'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†': () => showNotification('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...', 'info'),
        'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„': () => showNotification('ØªÙ… ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'info'),
        'Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª': () => showNotification('ØªÙ… ÙØªØ­ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†', 'info'),
        'ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø£Ù…Ø§Ù†': () => window.location.href = 'settings_usr.html'
    };
    
    if (actionMap[action]) {
        actionMap[action]();
    } else {
        showNotification(`ØªÙ… ØªÙ†ÙÙŠØ°: ${action}`, 'info');
    }
}

// Mark all as read
function markAllAsRead() {
    allAlerts.forEach(alert => {
        if (!alert.isResolved) {
            alert.isRead = true;
        }
    });
    saveAlerts();
    loadAlerts();
    showNotification('ØªÙ… ØªØ¹Ù„ÙŠÙ… Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©', 'success');
}

// Delete all resolved alerts
function deleteAllResolved() {
    const resolvedCount = allAlerts.filter(a => a.isResolved).length;
    if (resolvedCount === 0) {
        showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ø­Ù„ÙˆÙ„Ø© Ù„Ù„Ø­Ø°Ù', 'info');
        return;
    }
    
    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${resolvedCount} ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø­Ù„ÙˆÙ„ØŸ`)) {
        allAlerts = allAlerts.filter(a => !a.isResolved);
        saveAlerts();
        loadAlerts();
        showNotification(`ØªÙ… Ø­Ø°Ù ${resolvedCount} ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø­Ù„ÙˆÙ„`, 'success');
    }
}

// Export alerts
function exportAlerts() {
    const csvContent = [
        'Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ù†ÙˆØ¹,Ø§Ù„ÙØ¦Ø©,Ø§Ù„Ø¹Ù†ÙˆØ§Ù†,Ø§Ù„Ø±Ø³Ø§Ù„Ø©,Ø§Ù„Ø­Ø§Ù„Ø©',
        ...filteredAlerts.map(alert => [
            new Date(alert.timestamp).toLocaleDateString('ar-SA'),
            alert.type,
            getCategoryName(alert.category),
            `"${alert.title}"`,
            `"${alert.message}"`,
            alert.isResolved ? 'Ù…Ø­Ù„ÙˆÙ„' : (alert.isRead ? 'Ù…Ù‚Ø±ÙˆØ¡' : 'ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡')
        ].join(','))
    ].join('\n');
    
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'alerts-report.csv';
    link.click();
    
    showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// Save alert settings
function saveAlertSettings() {
    const settings = {
        financialAlerts: document.getElementById('financialAlerts').checked,
        expenseAlerts: document.getElementById('expenseAlerts').checked,
        revenueAlerts: document.getElementById('revenueAlerts').checked,
        securityAlerts: document.getElementById('securityAlerts').checked,
        systemAlerts: document.getElementById('systemAlerts').checked,
        emailNotifications: document.getElementById('emailNotifications').checked
    };
    
    localStorage.setItem('alertSettings', JSON.stringify(settings));
    alertSettings = settings;
    showNotification('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', 'success');
}

// Refresh alerts
function refreshAlerts() {
    showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª...', 'info');
    loadAlerts();
    applyFilters();
    showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', 'success');
}

// Generate random alert (simulating real-time alerts)
function generateRandomAlert() {
    const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const operations = JSON.parse(localStorage.getItem('operations') || '[]');
    
    // Only generate alerts if settings allow and operations exist
    if (operations.length === 0 || Math.random() > 0.3) return;
    
    const alertTemplates = [
        {
            type: 'warning',
            category: 'financial',
            title: 'ØªØ­Ø°ÙŠØ±: Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
            message: `Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¹ØªØ§Ø¯ Ø¨Ù†Ø³Ø¨Ø© ${Math.floor(Math.random() * 50 + 20)}%`,
            actions: ['Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', 'ÙˆØ¶Ø¹ Ø­Ø¯ÙˆØ¯ Ø¥Ù†ÙØ§Ù‚']
        },
        {
            type: 'info',
            category: 'operation',
            title: 'ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ Ø¬Ø§Ù‡Ø²',
            message: 'ØªÙ… Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙˆÙ‡Ùˆ Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
            actions: ['Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±', 'ØªØ­Ù…ÙŠÙ„ PDF']
        },
        {
            type: 'critical',
            category: 'security',
            title: 'ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ',
            message: 'ØªÙ… Ø±ØµØ¯ Ù†Ø´Ø§Ø· ØºÙŠØ± Ø¹Ø§Ø¯ÙŠ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠÙÙ†ØµØ­ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ù…Ø§Ù†',
            actions: ['ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†', 'ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±']
        }
    ];
    
    const template = alertTemplates[Math.floor(Math.random() * alertTemplates.length)];
    const newAlert = {
        id: 'alert-' + Date.now(),
        ...template,
        timestamp: new Date().toISOString(),
        isRead: false,
        isResolved: false
    };
    
    allAlerts.unshift(newAlert);
    saveAlerts();
    loadAlerts();
    
    // Show notification for new alert
    showNotification(`ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯: ${newAlert.title}`, newAlert.type);
}

// Save alerts to localStorage
function saveAlerts() {
    localStorage.setItem('userAlerts', JSON.stringify(allAlerts));
}

// Show notification
function showNotification(message, type = 'info') {
    let container = document.getElementById('notification-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        container.className = 'fixed top-4 left-4 z-50 space-y-2';
        document.body.appendChild(container);
    }
    
    const notification = document.createElement('div');
    const typeClasses = {
        'success': 'bg-green-500 text-white',
        'error': 'bg-red-500 text-white',
        'warning': 'bg-yellow-500 text-black',
        'info': 'bg-blue-500 text-white',
        'critical': 'bg-red-600 text-white'
    };
    
    notification.className = `p-4 rounded-lg shadow-lg transform transition-all duration-300 ${typeClasses[type]} max-w-sm opacity-0 translate-x-full`;
    notification.innerHTML = `
        <div class="flex items-center justify-between">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="mr-2 text-lg hover:text-gray-200">&times;</button>
        </div>
    `;
    
    container.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('opacity-0', 'translate-x-full');
    }, 100);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.classList.add('opacity-0', 'translate-x-full');
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

// Export functions for global access
window.refreshAlerts = refreshAlerts;
window.showAlertDetails = showAlertDetails;
window.closeAlertModal = closeAlertModal;
window.toggleAlertRead = toggleAlertRead;
window.resolveAlert = resolveAlert;
window.deleteAlert = deleteAlert;
window.handleAlertAction = handleAlertAction;
window.markAllAsRead = markAllAsRead;
window.deleteAllResolved = deleteAllResolved;
window.exportAlerts = exportAlerts;
window.saveAlertSettings = saveAlertSettings;
window.applyFilters = applyFilters;
</script>

</body>
</html>
